<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµµæ–‡å­—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ - Palette Generator Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ===== ãƒ†ãƒ¼ãƒå¤‰æ•° ===== */
    :root {
      --primary: #007bff;
      --primary-dim: rgba(0,123,255,0.12);
      --primary-glow: rgba(0,123,255,0.35);
      --lock-color: #f59e0b;
      --lock-dim: rgba(245,158,11,0.15);
      --shadow: 0 8px 32px rgba(31,38,135,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ===== ãƒ©ã‚¤ãƒˆ / ãƒ€ãƒ¼ã‚¯ ===== */
    html.light body {
      background: #f0f4ff;
      color: #1a1a2e;
    }
    html.dark body {
      background: linear-gradient(160deg, #0d0d14 0%, #111118 100%);
      color: #e8eaf0;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      padding: 24px 20px 80px;
      min-height: 100vh;
      transition: background 0.35s, color 0.35s;
    }

    .container { max-width: 920px; margin: 0 auto; }

    /* ===== ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    .page-header { margin-bottom: 28px; }
    .page-header h1 {
      font-family: 'Syne', sans-serif;
      font-size: 2rem;
      background: linear-gradient(45deg, #007bff, #00d4aa);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .page-header p { font-size: 13px; opacity: .55; margin-top: 5px; }

    /* ===== ã‚«ãƒ¼ãƒ‰ ===== */
    .card {
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 18px;
      border: 1px solid;
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s, background 0.35s;
    }
    html.light body .card {
      background: rgba(255,255,255,0.95);
      border-color: rgba(0,0,0,0.06);
    }
    html.dark body .card {
      background: rgba(22,22,32,0.9);
      border-color: rgba(255,255,255,0.07);
    }
    .card:hover { box-shadow: 0 14px 44px rgba(0,123,255,0.14); }

    .card-title {
      font-family: 'Syne', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 7px;
    }

    /* ===== çµ±è¨ˆãƒãƒ¼ ===== */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 18px;
    }
    .stat-box {
      background: var(--primary-dim);
      border: 1px solid rgba(0,123,255,0.2);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
    }
    .stat-box .num {
      font-family: 'Syne', sans-serif;
      font-size: 26px;
      font-weight: 800;
      color: var(--primary);
    }
    .stat-box .lbl { font-size: 11px; opacity: .6; margin-top: 2px; }

    /* ===== ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ— ===== */
    .section-label {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      opacity: .5;
      margin-bottom: 10px;
    }
    .cat-wrap { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 16px; }

    .cat-chip {
      padding: 6px 14px;
      border-radius: 20px;
      border: 2px solid rgba(0,123,255,0.3);
      background: transparent;
      color: inherit;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: all 0.18s;
      /* labelã‚¿ã‚°ã§ã¯ãªãbuttonã«å¤‰æ›´ã—ãŸã®ã§å†…éƒ¨inputã¯ä¸è¦ */
    }
    .cat-chip.on {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px var(--primary-glow);
    }
    .cat-chip:hover:not(.on) {
      border-color: var(--primary);
      background: var(--primary-dim);
    }
    /* æœ€å¾Œã®1å€‹ã‚’è§£é™¤ã—ã‚ˆã†ã¨ã—ãŸã¨ãè¦–è¦šçš„ã«ãƒ–ãƒ­ãƒƒã‚¯ */
    .cat-chip.last-one { cursor: not-allowed; }

    /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œ ===== */
    .controls-row {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .ctrl-block { display: flex; flex-direction: column; gap: 8px; }
    .ctrl-label { font-size: 12px; font-weight: 600; opacity: .55; }

    .count-select {
      padding: 9px 14px;
      border-radius: 10px;
      border: 1px solid rgba(128,128,128,0.25);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      min-width: 90px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    html.light body .count-select { background: #fff; color: #1a1a2e; border-color: #c8d0e0; }
    html.dark  body .count-select { background: #1c1c2a; color: #e8eaf0; border-color: #3a3a50; }
    .count-select:focus { outline: none; border-color: var(--primary); }

    /* ãƒ­ãƒƒã‚¯ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    .lock-global-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 10px;
      border: 2px solid rgba(245,158,11,0.4);
      background: transparent;
      color: inherit;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .lock-global-btn.locked-mode {
      background: var(--lock-dim);
      border-color: var(--lock-color);
      color: var(--lock-color);
    }

    /* ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ===== */
    .btn-row { display: flex; gap: 9px; flex-wrap: wrap; margin-bottom: 14px; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn:hover  { transform: translateY(-2px); filter: brightness(1.08); }
    .btn:active { transform: translateY(0); filter: brightness(.95); }
    .btn-primary { background: var(--primary); color: #fff; flex: 1; min-width: 100px; justify-content: center; }
    .btn-teal    { background: #0d9488; color: #fff; }
    .btn-amber   { background: #f59e0b; color: #fff; }
    .btn-slate   { background: #64748b; color: #fff; }

    /* ===== ãƒ’ãƒ³ãƒˆ ===== */
    .hint-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      opacity: .55;
      margin-bottom: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--primary-dim);
    }

    /* ===== çµµæ–‡å­—ã‚°ãƒªãƒƒãƒ‰ ===== */
    .emoji-grid-display {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(86px, 1fr));
      gap: 11px;
      min-height: 100px;
    }

    .emoji-box {
      position: relative;
      aspect-ratio: 1;
      border-radius: 14px;
      border: 2px solid rgba(0,123,255,0.2);
      background: var(--primary-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      cursor: pointer;
      transition: all 0.22s;
      user-select: none;
    }
    .emoji-box:hover { transform: scale(1.07); border-color: var(--primary); }

    /* é¸æŠ */
    .emoji-box.selected {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 20px var(--primary-glow);
      transform: scale(1.09);
    }
    /* ãƒ­ãƒƒã‚¯ */
    .emoji-box.locked {
      border-color: var(--lock-color);
      background: var(--lock-dim);
    }
    .emoji-box.locked::after {
      content: 'ğŸ”’';
      position: absolute;
      top: 4px; right: 5px;
      font-size: 13px;
      line-height: 1;
      pointer-events: none;
    }
    /* é¸æŠ + ãƒ­ãƒƒã‚¯ */
    .emoji-box.selected.locked {
      background: rgba(245,158,11,0.3);
      border-color: var(--lock-color);
      box-shadow: 0 0 20px rgba(245,158,11,0.4);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-grid {
      grid-column: 1/-1;
      text-align: center;
      padding: 40px;
      opacity: .35;
      font-size: 15px;
    }
    .empty-grid .icon { font-size: 40px; margin-bottom: 10px; }

    /* ===== å±¥æ­´ ===== */
    .history-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      min-height: 36px;
    }
    .history-chip {
      font-size: 24px;
      padding: 5px 9px;
      border-radius: 9px;
      background: var(--primary-dim);
      border: 1px solid rgba(0,123,255,0.18);
      cursor: pointer;
      transition: all 0.18s;
    }
    .history-chip:hover { transform: scale(1.18); background: rgba(0,123,255,0.22); }

    /* ===== ãƒˆãƒ¼ã‚¹ãƒˆ ===== */
    .toast {
      position: fixed;
      bottom: 28px; left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: rgba(10,10,18,0.9);
      color: #fff;
      padding: 11px 22px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.28s, transform 0.28s;
      z-index: 2000;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ===== */
    @media (max-width: 600px) {
      .page-header h1 { font-size: 1.6rem; }
      .controls-row { flex-direction: column; align-items: flex-start; }
      .emoji-grid-display { grid-template-columns: repeat(auto-fill, minmax(72px,1fr)); }
      .stats-row { grid-template-columns: repeat(3,1fr); }
      .btn { font-size: 12px; padding: 9px 14px; }
    }
  </style>

  <!-- ãƒ†ãƒ¼ãƒå³æ™‚é©ç”¨ -->
  <script>
    (function(){
      const t = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.className = t;
    })();
  </script>
</head>
<body>

<div id="mainNav"></div>
<div id="toast" class="toast"></div>

<div class="container">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="page-header">
    <h1>ğŸ˜Š çµµæ–‡å­—ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ / ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ / å³ã‚¯ãƒªãƒƒã‚¯ï¼ˆé•·æŠ¼ã—ï¼‰ã§ãƒ­ãƒƒã‚¯</p>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="stats-row">
    <div class="stat-box">
      <div class="num" id="statTotal">0</div>
      <div class="lbl">ç·ç”Ÿæˆæ•°</div>
    </div>
    <div class="stat-box">
      <div class="num" id="statLocked">0</div>
      <div class="lbl">ãƒ­ãƒƒã‚¯ä¸­</div>
    </div>
    <div class="stat-box">
      <div class="num" id="statHistory">0</div>
      <div class="lbl">å±¥æ­´æ•°</div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-title">ğŸ² çµµæ–‡å­—ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ</div>

    <!-- ã‚«ãƒ†ã‚´ãƒª -->
    <div class="section-label">ã‚«ãƒ†ã‚´ãƒªï¼ˆè¤‡æ•°é¸æŠå¯ãƒ»æœ€ä½1ã¤ï¼‰</div>
    <div class="cat-wrap" id="catWrap">
      <button class="cat-chip on" data-cat="smileys">ğŸ˜€ é¡”ãƒ»ç¬‘é¡”</button>
      <button class="cat-chip"   data-cat="animals">ğŸ± å‹•ç‰©ãƒ»è‡ªç„¶</button>
      <button class="cat-chip"   data-cat="food">ğŸ• é£Ÿã¹ç‰©</button>
      <button class="cat-chip"   data-cat="travel">âœˆï¸ æ—…è¡Œ</button>
      <button class="cat-chip"   data-cat="activities">âš½ æ´»å‹•</button>
      <button class="cat-chip"   data-cat="objects">ğŸ’» ç‰©</button>
      <button class="cat-chip"   data-cat="hearts">â¤ï¸ ãƒãƒ¼ãƒˆ</button>
      <button class="cat-chip"   data-cat="symbols">â­ è¨˜å·</button>
    </div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls-row">
      <div class="ctrl-block">
        <span class="ctrl-label">ç”Ÿæˆæ•°</span>
        <select class="count-select" id="countSelect">
          <option value="1">1å€‹</option>
          <option value="2">2å€‹</option>
          <option value="3">3å€‹</option>
          <option value="4">4å€‹</option>
          <option value="5">5å€‹</option>
          <option value="6" selected>6å€‹</option>
          <option value="8">8å€‹</option>
          <option value="10">10å€‹</option>
        </select>
      </div>
      <div class="ctrl-block">
        <span class="ctrl-label">ãƒ­ãƒƒã‚¯è¨­å®š</span>
        <button class="lock-global-btn" id="lockGlobalBtn" onclick="toggleAllLock()">
          ğŸ”“ å…¨ãƒ­ãƒƒã‚¯è§£é™¤ä¸­
        </button>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="btn-row">
      <button class="btn btn-primary" onclick="generateEmojis()">ğŸ² ç”Ÿæˆ</button>
      <button class="btn btn-teal"    onclick="copySelected()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-amber"   onclick="unlockAll()">ğŸ”“ å…¨è§£é™¤</button>
      <button class="btn btn-slate"   onclick="resetSelection()">â†º é¸æŠãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ãƒ’ãƒ³ãƒˆ -->
    <div class="hint-bar">
      ğŸ’¡ <span>ã‚¯ãƒªãƒƒã‚¯ â†’ é¸æŠåˆ‡æ›¿ ï¼ å³ã‚¯ãƒªãƒƒã‚¯ãƒ»é•·æŠ¼ã— â†’ ğŸ”’ãƒ­ãƒƒã‚¯ï¼ˆæ¬¡å›ç”Ÿæˆã§ã‚‚ä¿æŒï¼‰</span>
    </div>

    <!-- çµµæ–‡å­—è¡¨ç¤º -->
    <div class="emoji-grid-display" id="emojiDisplay">
      <div class="empty-grid">
        <div class="icon">ğŸ²</div>
        <div>ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- å±¥æ­´ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="card-title">ğŸ“ æœ€è¿‘ç”Ÿæˆã—ãŸçµµæ–‡å­—</div>
    <div class="history-wrap" id="historyWrap">
      <span style="opacity:.4;font-size:13px;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>
    </div>
  </div>

  <!-- ä»–ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ -->
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <a href="pose-generator.html"  style="display:inline-flex;align-items:center;gap:6px;padding:11px 20px;border-radius:10px;background:#7c3aed;color:#fff;text-decoration:none;font-weight:700;font-size:13px;transition:all .2s;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">ğŸ§ ãƒãƒ¼ã‚ºãƒ»æ§‹å›³ â†’</a>
    <a href="chara-generator.html" style="display:inline-flex;align-items:center;gap:6px;padding:11px 20px;border-radius:10px;background:#10b981;color:#fff;text-decoration:none;font-weight:700;font-size:13px;transition:all .2s;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">ğŸ‘¥ ã‚­ãƒ£ãƒ©æ§‹æˆ â†’</a>
  </div>

</div><!-- /container -->

<script src="auth.js"></script>
<script src="common.js"></script>
<script>
// ========== çµµæ–‡å­—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ==========
const emojiDB = {
  smileys:    ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ˜‡','ğŸ™‚','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ¤‘','ğŸ¤—','ğŸ¤”','ğŸ˜','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ˜”','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ˜•','ğŸ˜®','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ’€','ğŸ¤¡','ğŸ‘»','ğŸ‘½','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜»','ğŸ˜¼'],
  animals:    ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸº','ğŸ´','ğŸ¦„','ğŸ¦‹','ğŸŒ','ğŸ','ğŸ¢','ğŸ','ğŸ¦','ğŸ™','ğŸ¬','ğŸ³','ğŸ¦ˆ','ğŸ˜','ğŸ¦’','ğŸ¦Œ','ğŸ•','ğŸˆ','ğŸ¦š','ğŸ¦œ','ğŸŒ¿','ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ·','ğŸ€','ğŸŒˆ','ğŸŒŠ','ğŸŒ‹'],
  food:       ['ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥‘','ğŸ¥•','ğŸŒ½','ğŸ¥’','ğŸ…','ğŸ¥','ğŸ','ğŸ¥š','ğŸ³','ğŸ¥','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ®','ğŸŒ¯','ğŸ£','ğŸ±','ğŸœ','ğŸ','ğŸ²','ğŸ¦','ğŸ°','ğŸ‚','ğŸ§','ğŸ©','ğŸª','ğŸ«','ğŸ¿','â˜•','ğŸµ','ğŸ§ƒ','ğŸº','ğŸ·','ğŸ¸','ğŸ§‹'],
  travel:     ['âœˆï¸','ğŸš€','ğŸ›¸','ğŸš','ğŸš‚','ğŸš„','ğŸš‡','ğŸšŒ','ğŸš—','ğŸš•','ğŸ›µ','â›µ','ğŸš¤','ğŸ›³ï¸','ğŸ—¼','ğŸ—½','ğŸ°','ğŸ¡','â›°ï¸','ğŸ”ï¸','ğŸŒ‹','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸ•ï¸','ğŸŒƒ','ğŸŒ†','ğŸŒ‡','ğŸŒ‰'],
  activities: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ³','ğŸ“','ğŸ¥Š','â›³','ğŸ£','ğŸ¿','ğŸ¯','ğŸ®','ğŸ­','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¸','ğŸ¥','ğŸº','ğŸ·','ğŸ»','ğŸ²','â™Ÿï¸','ğŸ†','ğŸ¥‡','ğŸ‹ï¸','ğŸ¤¸','ğŸ§˜','ğŸš´'],
  objects:    ['ğŸ’¼','âŒš','ğŸ“±','ğŸ’»','ğŸ–¥ï¸','ğŸ•¹ï¸','ğŸ’¾','ğŸ“·','ğŸ“º','ğŸ“»','â°','ğŸ”‹','ğŸ’¡','ğŸ”¦','ğŸ’¸','âœ‰ï¸','ğŸ“¦','ğŸ”‘','ğŸ”’','ğŸ”“','ğŸ§²','ğŸ”¬','ğŸ”­','ğŸ“š','ğŸ“–','ğŸ“','âœï¸','ğŸ“Œ','âœ‚ï¸','ğŸ§°','âš™ï¸','ğŸ”§','ğŸ”¨'],
  hearts:     ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â£ï¸','â™¥ï¸'],
  symbols:    ['â­','ğŸŒŸ','âœ¨','ğŸ’«','âš¡','ğŸ”¥','ğŸŒŠ','ğŸ’¥','â„ï¸','ğŸŒˆ','â˜€ï¸','ğŸŒ™','ğŸ”µ','ğŸŸ¢','ğŸŸ¡','ğŸŸ ','ğŸ”´','ğŸŸ£','â™ ï¸','â™¥ï¸','â™¦ï¸','â™£ï¸','âœ…','âŒ','âš ï¸','ğŸ’¯','ğŸ'],
};

// ========== çŠ¶æ…‹ ==========
let currentEmojis   = []; // [{ emoji, locked }]
let generationHistory = [];
let allLockedMode   = false; // ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ã®ä¸€æ‹¬è¡¨ç¤ºç”¨ï¼ˆUIã®ã¿ï¼‰

// ========== ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ— ==========
function initCatChips() {
  const chips = document.querySelectorAll('#catWrap .cat-chip');

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      const isOn = chip.classList.contains('on');
      const onCount = document.querySelectorAll('#catWrap .cat-chip.on').length;

      // æœ€å¾Œã®1å€‹ã‚’ã‚ªãƒ•ã«ã—ã‚ˆã†ã¨ã—ãŸã‚‰ãƒ–ãƒ­ãƒƒã‚¯
      if (isOn && onCount === 1) {
        chip.classList.add('last-one');
        showToast('âš ï¸ æœ€ä½1ã¤ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„');
        setTimeout(() => chip.classList.remove('last-one'), 800);
        return;
      }
      chip.classList.toggle('on', !isOn);
    });
  });
}

// ========== çµµæ–‡å­—ç”Ÿæˆ ==========
function generateEmojis() {
  const count = parseInt(document.getElementById('countSelect').value);
  const selectedCats = [...document.querySelectorAll('#catWrap .cat-chip.on')]
    .map(c => c.dataset.cat);

  // ãƒ—ãƒ¼ãƒ«æ§‹ç¯‰
  let pool = [];
  selectedCats.forEach(c => { pool = pool.concat(emojiDB[c]); });
  pool = [...new Set(pool)];

  // ãƒ­ãƒƒã‚¯æ¸ˆã¿ã‚’ä¿æŒ
  const locked = currentEmojis.filter(e => e.locked);
  const needCount = Math.max(0, count - locked.length);

  // æ–°è¦ç”Ÿæˆ
  const newEmojis = [];
  for (let i = 0; i < needCount; i++) {
    newEmojis.push({ emoji: pool[Math.floor(Math.random() * pool.length)], locked: false });
  }

  currentEmojis = [...locked, ...newEmojis].slice(0, count);
  renderEmojiDisplay();

  // å±¥æ­´è¿½åŠ ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  newEmojis.forEach(e => {
    if (!generationHistory.includes(e.emoji)) generationHistory.unshift(e.emoji);
  });
  if (generationHistory.length > 60) generationHistory.length = 60;
  localStorage.setItem('emojiHistory', JSON.stringify(generationHistory));
  renderHistory();
  updateStats();

  const lMsg = locked.length > 0 ? `ï¼ˆğŸ”’${locked.length}å€‹ä¿æŒï¼‰` : '';
  showToast(`${count}å€‹ç”Ÿæˆã—ã¾ã—ãŸï¼${lMsg}`);
}

// ========== æç”» ==========
function renderEmojiDisplay() {
  const display = document.getElementById('emojiDisplay');
  display.innerHTML = '';

  if (currentEmojis.length === 0) {
    display.innerHTML = '<div class="empty-grid"><div class="icon">ğŸ²</div><div>ã€Œç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div></div>';
    return;
  }

  currentEmojis.forEach((item, i) => {
    const box = document.createElement('div');
    box.className = 'emoji-box' +
      (item.locked   ? ' locked'   : '') +
      (item.selected ? ' selected' : '');
    box.textContent = item.emoji;
    box.title = item.locked
      ? 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼‰'
      : 'ã‚¯ãƒªãƒƒã‚¯: é¸æŠ ï¼ å³ã‚¯ãƒªãƒƒã‚¯ãƒ»é•·æŠ¼ã—: ãƒ­ãƒƒã‚¯';

    // ã‚¯ãƒªãƒƒã‚¯ â†’ é¸æŠãƒˆã‚°ãƒ«
    box.addEventListener('click', () => {
      item.selected = !item.selected;
      box.classList.toggle('selected', item.selected);
    });

    // å³ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ­ãƒƒã‚¯ãƒˆã‚°ãƒ«
    box.addEventListener('contextmenu', e => {
      e.preventDefault();
      item.locked = !item.locked;
      box.classList.toggle('locked', item.locked);
      box.title = item.locked
        ? 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼‰'
        : 'ã‚¯ãƒªãƒƒã‚¯: é¸æŠ ï¼ å³ã‚¯ãƒªãƒƒã‚¯ãƒ»é•·æŠ¼ã—: ãƒ­ãƒƒã‚¯';
      updateStats();
      showToast(item.locked ? `ğŸ”’ ${item.emoji} ã‚’ãƒ­ãƒƒã‚¯` : `ğŸ”“ ãƒ­ãƒƒã‚¯è§£é™¤`);
    });

    // é•·æŠ¼ã— â†’ ãƒ­ãƒƒã‚¯ãƒˆã‚°ãƒ«ï¼ˆã‚¿ãƒƒãƒå¯¾å¿œï¼‰
    let timer;
    box.addEventListener('touchstart', () => {
      timer = setTimeout(() => {
        item.locked = !item.locked;
        box.classList.toggle('locked', item.locked);
        updateStats();
        showToast(item.locked ? `ğŸ”’ ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ` : `ğŸ”“ è§£é™¤ã—ã¾ã—ãŸ`);
      }, 500);
    }, { passive: true });
    box.addEventListener('touchend', () => clearTimeout(timer), { passive: true });
    box.addEventListener('touchmove', () => clearTimeout(timer), { passive: true });

    display.appendChild(box);
  });
}

// ========== ä¸€æ‹¬ãƒ­ãƒƒã‚¯ ==========
function toggleAllLock() {
  if (currentEmojis.length === 0) { showToast('å…ˆã«çµµæ–‡å­—ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'); return; }
  allLockedMode = !allLockedMode;
  currentEmojis.forEach(e => { e.locked = allLockedMode; });
  const btn = document.getElementById('lockGlobalBtn');
  btn.textContent = allLockedMode ? 'ğŸ”’ å…¨ãƒ­ãƒƒã‚¯ä¸­' : 'ğŸ”“ å…¨ãƒ­ãƒƒã‚¯è§£é™¤ä¸­';
  btn.classList.toggle('locked-mode', allLockedMode);
  renderEmojiDisplay();
  updateStats();
  showToast(allLockedMode ? 'ğŸ”’ å…¨éƒ¨ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ' : 'ğŸ”“ å…¨ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸ');
}

function unlockAll() {
  currentEmojis.forEach(e => { e.locked = false; });
  allLockedMode = false;
  const btn = document.getElementById('lockGlobalBtn');
  btn.textContent = 'ğŸ”“ å…¨ãƒ­ãƒƒã‚¯è§£é™¤ä¸­';
  btn.classList.remove('locked-mode');
  renderEmojiDisplay();
  updateStats();
  showToast('ğŸ”“ å…¨ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ');
}

// ========== é¸æŠãƒªã‚»ãƒƒãƒˆ ==========
function resetSelection() {
  currentEmojis.forEach(e => { e.selected = false; });
  document.querySelectorAll('.emoji-box').forEach(b => b.classList.remove('selected'));
  showToast('é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

// ========== ã‚³ãƒ”ãƒ¼ ==========
function copySelected() {
  const selectedItems = currentEmojis.filter(e => e.selected);
  if (selectedItems.length === 0) {
    const all = currentEmojis.map(e => e.emoji).join('');
    if (!all) { showToast('å…ˆã«çµµæ–‡å­—ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'); return; }
    navigator.clipboard.writeText(all);
    showToast('å…¨çµµæ–‡å­—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  } else {
    navigator.clipboard.writeText(selectedItems.map(e => e.emoji).join(''));
    showToast(`${selectedItems.length}å€‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`);
  }
}

// ========== å±¥æ­´ ==========
function renderHistory() {
  const wrap = document.getElementById('historyWrap');
  if (generationHistory.length === 0) {
    wrap.innerHTML = '<span style="opacity:.4;font-size:13px;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>';
    return;
  }
  wrap.innerHTML = generationHistory.slice(0, 40).map(e => {
    const safe = e.replace(/'/g, '&#39;');
    return `<span class="history-chip" title="${safe}ã‚’ã‚³ãƒ”ãƒ¼"
      onclick="navigator.clipboard.writeText('${safe}');showToast('${safe} ã‚’ã‚³ãƒ”ãƒ¼ï¼')">${e}</span>`;
  }).join('');
}

// ========== çµ±è¨ˆ ==========
function updateStats() {
  document.getElementById('statTotal').textContent   = generationHistory.length;
  document.getElementById('statLocked').textContent  = currentEmojis.filter(e => e.locked).length;
  document.getElementById('statHistory').textContent = generationHistory.length;
}

// ========== ãƒˆãƒ¼ã‚¹ãƒˆ ==========
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(() => t.classList.remove('show'), 2300);
}

// ========== åˆæœŸåŒ– ==========
window.onload = () => {
  const user = requireAuth();
  if (!user) return;
  injectCommonStyles();
  buildNav('emoji');

  initCatChips();

  generationHistory = JSON.parse(localStorage.getItem('emojiHistory') || '[]');
  renderHistory();
  updateStats();
};
</script>
</body>
</html>
